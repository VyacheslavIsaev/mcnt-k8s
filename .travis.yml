sudo: required
services:
    - docker

before_install:
    # Downloading gcloud package
    - curl https://dl.google.com/dl/cloudsdk/release/google-cloud-sdk.tar.gz > ./google-cloud-sdk.tar.gz
    - mkdir -p ./gcloud 
    - tar -C ./gcloud -xvf ./google-cloud-sdk.tar.gz
    - ./gcloud/google-cloud-sdk/install.sh -q
    - source ./gcloud/google-cloud-sdk/path.bash.inc
    - gcloud components update kubectl
    - gcloud auth activate-service-account --key-file service-account.json


script:
    #after_success:
    - docker build -t $DOCKER_ID/mcnt-uix ./uix
    - docker build -t $DOCKER_ID/mcnt-api ./api
    - docker build -t $DOCKER_ID/mcnt-nginx ./nginx
    - docker build -t $DOCKER_ID/mcnt-worker ./worker
    - echo "$DOCKER_PASSWD" | docker login -u "$DOCKER_ID" --password-stdin
    - docker push $DOCKER_ID/mcnt-uix
    - docker push $DOCKER_ID/mcnt-api
    - docker push $DOCKER_ID/mcnt-nginx
    - docker push $DOCKER_ID/mcnt-worker

deploy:
    provider: elasticbeanstalk
    region: us-east-2
    app: mcnt
    env: Mcnt-env
    bucket_name: elasticbeanstalk-us-east-2-015560362832
    bucket_path: mcnt
    on:
        branch: master    
    access_key_id: $AWS_ACCESS_KEY_ID
    secret_access_key: $AWS_SECRET_KEY
